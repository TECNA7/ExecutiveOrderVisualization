<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Executive Orders Timeline</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial; margin: 40px; }
    #timeline { width: 100%; height: 600px; }
  </style>
</head>
<body>
  <h2>Executive Orders Timeline Explorer</h2>
  <div id="timeline"></div>

  <script>
    function getPresident(dateStr) {
      const date = new Date(dateStr);
      const presidents = [
        { name: "President 47: Donald Trump", start: "2025-01-20"}, 
        { name: "President 46: Joe Biden", start: "2021-01-20" },
        { name: "President 45: Donald Trump", start: "2017-01-20" },
        { name: "President 44: Barack Obama", start: "2009-01-20" },
        { name: "President 43: George W. Bush", start: "2001-01-20" },
        { name: "President 42: Bill Clinton", start: "1993-01-20" },
        { name: "President 41: George H. W. Bush", start: "1989-01-20" },
        { name: "President 40: Ronald Reagan", start: "1981-01-20" }
      ];
      for (let i = 0; i < presidents.length; i++) {
        const start = new Date(presidents[i].start);
        const end = i === 0 ? new Date() : new Date(presidents[i - 1].start);
        if (date >= start && date < end) {
          return presidents[i].name;
        }
      }
      return "Unknown";
    }

    d3.csv("./executive_orders.csv").then(function(data) {
      const grouped = {};
      const pointCounts = {}; // NEW: count of (president, date)

      data.forEach(d => {
        const parseDate = d3.timeParse("%m/%d/%Y");
        const dateObj = parseDate(d.signing_date.trim());
        const date = dateObj ? dateObj.toISOString().split("T")[0] : null;
        if (!date) return;

        const title = d.title;
        const url = d.html_url || d.pdf_url || "";
        const president = getPresident(date);

        const key = `${president}__${date}`;
        pointCounts[key] = (pointCounts[key] || 0) + 1;

        if (!grouped[president]) grouped[president] = { x: [], y: [], text: [], customdata: [], size: [] };
        grouped[president].x.push(date);
        grouped[president].y.push(president);
        grouped[president].text.push(`(${pointCounts[key]} EO${pointCounts[key] > 1 ? "s" : ""}) ${d.executive_order_number ? "EO " + d.executive_order_number + ": " : ""}${title}`);
        grouped[president].customdata.push(url);
        grouped[president].size.push(pointCounts[key] * 5); // scale factor
      });

      const traces = Object.keys(grouped).map(president => ({
        type: 'scatter',
        mode: 'markers',
        name: president,
        x: grouped[president].x,
        y: grouped[president].y,
        text: grouped[president].text,
        customdata: grouped[president].customdata,
        marker: {
          size: grouped[president].size,
          sizemode: 'diameter',
          sizeref: 2,
          sizemin: 8
        }
      }));

      // EO count annotations
      const annotations = Object.entries(grouped).map(([president, group]) => {
        const dates = group.x.map(d => new Date(d));
        const maxDate = new Date(Math.max(...dates));
        const count = group.x.length;

        return {
          x: maxDate.toISOString().split("T")[0],
          y: president,
          text: `üìù ${count} orders`,
          showarrow: true,
          arrowhead: 4,
          ax: 40,
          ay: -20,
          font: { size: 12, color: 'black' },
          bgcolor: 'rgba(255,255,255,0.7)',
          bordercolor: 'gray',
          borderwidth: 1
        };
      });

      const layout = {
        title: 'Executive Orders Over Time',
        hovermode: 'closest',
        xaxis: { title: 'Signing Date', type: 'date', autorange: true },
        yaxis: {
          title: 'President',
          automargin: true,
          categoryorder: 'array',
          categoryarray: Object.keys(grouped).reverse() // newest at bottom
        },
        annotations: annotations
      };

      Plotly.newPlot('timeline', traces, layout);

      document.getElementById('timeline').on('plotly_click', function(data){
        const url = data.points[0].customdata;
        if (url) window.open(url, '_blank');
      });
    });
  </script>
</body>
</html>
